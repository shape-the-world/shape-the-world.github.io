<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Shape the world Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Shape the world Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">Pipeline and data management | Shape the world</title><meta data-react-helmet="true" property="og:title" content="Pipeline and data management | Shape the world"><meta data-react-helmet="true" property="og:url" content="https://shape-the-world.github.io/case-studies/vertebra/pipeline-and-data-management/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shape-the-world.github.io/case-studies/vertebra/pipeline-and-data-management/"><link data-react-helmet="true" rel="alternate" href="https://shape-the-world.github.io/case-studies/vertebra/pipeline-and-data-management/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shape-the-world.github.io/case-studies/vertebra/pipeline-and-data-management/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.adaee50e.css">
<link rel="preload" href="/assets/js/runtime~main.5614929a.js" as="script">
<link rel="preload" href="/assets/js/main.879e3bc5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/world.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/world.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Shape the world</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">About us</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/about/vision/">Vision</a></li><li><a class="dropdown__link" href="/about/partners/">Partners</a></li><li><a class="dropdown__link" href="/about/credits/">Credits</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">Case studies</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/case-studies/vertebra/vertebra/">2D/3D registration of vertebra</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">Models</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/models/models-overview/">Statistical shape models</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">Theory</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/theory/scientific-articles/">Scientific articles</a></li><li><a class="dropdown__link" href="/theory/primers/">Primers</a></li><li><a class="dropdown__link" href="/theory/courses/">Courses</a></li></ul></div><a class="navbar__item navbar__link" href="/conversations/">Conversations</a><a class="navbar__item navbar__link" href="/resources/">Resources</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mdx-wrapper mdx-page"><main class="container container--fluid margin-vert--lg"><div class="row mdxPageWrapper_3qD3"><div class="col col--8"><header><h1 class="h1Heading_27L5">Pipeline and data managementt</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="data-management"></a>Data management<a class="hash-link" href="#data-management" title="Direct link to heading">#</a></h2><p>Data plays a crucial role in shape modelling applications. The shape is learned from
a set of tetrahedral or triangle meshes and the intensity distribution is usally estimated
from a set of images. The data itself usually goes through several differnet stages. It needs to be landmarked, aligned and brought into correspondence. Depending on the application, additional steps might be needed. </p><p>Although all the steps in data handling are, in principle, straight-forward, it has shown in practice shape modelling pipelines quickly become messy and difficult
to maintain when data is handled ad-hoc. We therefore start this case study with discussing an approach for data handling in shape modelling applications. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="data-repository"></a>Data repository<a class="hash-link" href="#data-repository" title="Direct link to heading">#</a></h3><p>The core idea is the following: </p><blockquote><p>Data should never be explicitly referred to by its filename or URI. Rather, it is accessed through a data repository, using an abstract identifier (case-id) and processing stage to identify the data.  </p></blockquote><p>This simple principle ensures that all information on how the data is stored and used is
stored in a single place, namely the data repository. In our pipeline, the data repository is represented by a Scala <code>trait</code> (an inteface), which defines how we
can interact with the data, plus a concrete implementation, which provides the concrete
mapping to the datasets, as they are physically stored in the filesystem or the database. </p><p>The DataRepository class looks as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><pre tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">trait DataRepository {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  def caseIds: Seq[CaseId]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  def triangleMesh(stage: Stage, id: CaseId): Try[TriangleMesh[_3D]]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  def saveTriangleMesh(stage: Stage, id: CaseId, mesh: TriangleMesh[_3D]): Try[Unit]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  def tetrahedralMesh(stage: Stage, id: CaseId): Try[TetrahedralMesh[_3D]]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  def saveTetrahedralMesh(stage: Stage, id: CaseId, mesh: TetrahedralMesh[_3D]): Try[Unit]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  def landmarks(stage: Stage, id: CaseId): Try[Seq[Landmark[_3D]]]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>(See the code on <a href="https://github.com/shape-the-world/vertebra-case-study/blob/main/src/main/scala/data/DataRepository.scala" target="_blank" rel="noopener noreferrer">Github</a> for more details.)</p><p>We see that data is accessed by specifying its <code>id</code> and the <code>stage</code> it is in.
The id is just an identifier for each dataset. Typically, this id is
part of the filename of the dataset. The stage instead, refers to the processing stage
of the data. In a typical shape modelling application, we are distinguishing the folowing
stages:</p><ul><li>Initial: The raw data as we get it from a database</li><li>Aligned: All the data have been aligned to a common reference coordinate system, which is typically determined using a dataset as a reference and aligning all the data to it using e.g. procrustes alignment. </li><li>Registered: The meshes are in correspondence with a reference mesh, that was selected.</li></ul><p>In code, the stage is defined as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><pre tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">sealed trait Stage</span></span><span class="token-line" style="color:#393A34"><span class="token plain">case object Initial extends Stage </span></span><span class="token-line" style="color:#393A34"><span class="token plain">case object Aligned extends Stage </span></span><span class="token-line" style="color:#393A34"><span class="token plain">case class Registered(level: ResolutionLevel) extends Stage</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We see that for the stage <code>Registered</code> we also distinguish between different resolution levels of the reference mesh. This is useful when we want to build
models on different resolution levels. </p><p>The <code>DataRepository</code> is just an interface. There can be several concrete implementations of it. As part of the pipeline, we provide the
<a href="https://github.com/shape-the-world/vertebra-case-study/blob/main/src/main/scala/data/DirectoryBasedDataRepository.scala" target="_blank" rel="noopener noreferrer">DirectoryBasedDataRepository</a>, which provides a concrete implementation, which assumes that the
data are stored on the filesystem. It presupposes a special directory organisation. The implementation therefore also directly serves as documentation
about how the data is organized. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="errorhandling--logging-and-debugging"></a>Errorhandling,  Logging and Debugging<a class="hash-link" href="#errorhandling--logging-and-debugging" title="Direct link to heading">#</a></h2><p>We see in the above code snippets that the functions to load the data do not simply return the dataset, such as a <code>TriangleMesh[_3D]</code>, but rather a <code>Try[TriangleMesh[_3D]]</code>. Wrapping all the data in a <code>Try</code> makes it possible to
do principled error handling from within the pipeline. While this has some upfront cost in developing the pipeline, it will make life easier when running the pipeline. In a similar spirit, we use a logging framework to produce output from our simulation. </p><p>When developing the pipeline it is important that we can visually assess the output. Our code therefore makes extensive use of  <a href="https://github.com/unibas-gravis/scalismo-ui" target="_blank" rel="noopener noreferrer">Scalismo-ui</a> for visualizing the datasets, the processes and the results. The GUI that does the visualization is started using </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><pre tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val ui = ScalismoUI()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once the pipeline is stable and we would like to run it on a server, we can simply replace that call with </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly scala"><pre tabindex="0" class="prism-code language-scala codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">val ui = ScalismoUIHeadless()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will supress any debugging output.</p></div><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#data-management" class="table-of-contents__link">Data management</a><ul><li><a href="#data-repository" class="table-of-contents__link">Data repository</a></li></ul></li><li><a href="#errorhandling--logging-and-debugging" class="table-of-contents__link">Errorhandling,  Logging and Debugging</a></li></ul></div></div></div></main></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Shape-the-world</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5614929a.js"></script>
<script src="/assets/js/main.879e3bc5.js"></script>
</body>
</html>