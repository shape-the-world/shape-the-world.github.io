<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Shape the world Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Shape the world Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">Shape model building | Shape the world</title><meta data-react-helmet="true" property="og:title" content="Shape model building | Shape the world"><meta data-react-helmet="true" property="og:url" content="https://shape-the-world.github.io/case-studies/vertebra/shape-model-building/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shape-the-world.github.io/case-studies/vertebra/shape-model-building/"><link data-react-helmet="true" rel="alternate" href="https://shape-the-world.github.io/case-studies/vertebra/shape-model-building/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shape-the-world.github.io/case-studies/vertebra/shape-model-building/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.adaee50e.css">
<link rel="preload" href="/assets/js/runtime~main.d4b9d08f.js" as="script">
<link rel="preload" href="/assets/js/main.879e3bc5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/world.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/world.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Shape the world</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">About us</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/about/vision/">Vision</a></li><li><a class="dropdown__link" href="/about/partners/">Partners</a></li><li><a class="dropdown__link" href="/about/credits/">Credits</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">Case studies</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/case-studies/vertebra/vertebra/">2D/3D registration of vertebra</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">Models</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/models/models-overview/">Statistical shape models</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">Theory</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/theory/scientific-articles/">Scientific articles</a></li><li><a class="dropdown__link" href="/theory/primers/">Primers</a></li><li><a class="dropdown__link" href="/theory/courses/">Courses</a></li></ul></div><a class="navbar__item navbar__link" href="/conversations/">Conversations</a><a class="navbar__item navbar__link" href="/resources/">Resources</a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mdx-wrapper mdx-page"><main class="container container--fluid margin-vert--lg"><div class="row mdxPageWrapper_3qD3"><div class="col col--8"><header><h1 class="h1Heading_27L5">Building the statistical shape model</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="data-screening"></a>Data screening<a class="hash-link" href="#data-screening" title="Direct link to heading">#</a></h2><p>The statistical model of the lumbar spine was developed from the <a href="https://github.com/anjany/verse" target="_blank" rel="noopener noreferrer">VerSe’20</a> public dataset. The dataset consists of data from multiple multi-detector CT scanners and includes a range of field-of-view and scan settings. The data incudes ground-truth segmentation masks and vertebral centroid annotations. The VerSe’20 dataset contained instances of vertebral fractures, foreign material and metal implants, therefore, the images were screened and only individuals with complete lumbar spine (L1-L5) and no bone pathologies or obstructions were used to construct the model. Currently, the model is constructed from 18 subjects from the VerSe’20 training set.<br>
Using the segmentation masks, the surface meshes of each lumbar level were extracted from the corresponding CT images. The model for each lumbar level, across the dataset, was constructed independently. The same method is used for all the lumber spines.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="initial-reference-selection"></a>Initial reference selection<a class="hash-link" href="#initial-reference-selection" title="Direct link to heading">#</a></h2><p>A reference mesh was randomly selected from the 18 L1 surface meshes, and seven landmarks were manually identified on its surface using Scalismo graphic user interface (GUI). Four landmarks were identified on the vertebral body: anterior and posterior points on the superior and inferior planes of the vertebral body. Two landmarks were identified on the transverse processes, one on each side, and the final landmark on the spinous process (Fig. 1). </p><p><img alt="Reference shape" src="/assets/images/reference-46e995216a18a927ca76c12209d43ef0.png"></p><p>In addition to the surface mesh, the tetrahedral mesh was required for the model building process and a tetrahedral mesh of the reference was constructed using Amira software v6.2.0 (<a href="http://www.fei.com/" target="_blank" rel="noopener noreferrer">http://www.fei.com/</a>).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="alignement"></a>Alignement<a class="hash-link" href="#alignement" title="Direct link to heading">#</a></h2><p>To establish dense correspondence among the L1 vertebra in the dataset, the first step is to perform a rigid alignment, in order for all the datasets to be in the same coordinate system. The reference landmarks were used to rigidly align the 17 L1 extracted surfaces to the reference surface. The rigid alignment removes any rotation and translation differences between the data. As a result, the only differences that will be modeled are shape and intensity differences. Similar landmarks as those annotated on the reference and in the same order were manually annotated on the rest of the dataset.
Each target surface was aligned to the reference surface by finding the best rigid transformation from the set of landmarks. The best transformation was found by minimizing the mean square error between corresponding landmark points.  T</p><p>The code for aligning the data can be found in the class <a href="https://github.com/shape-the-world/vertebra-case-study/blob/main/src/main/scala/pipeline/AlignData.scala" target="_blank" rel="noopener noreferrer">AlignData.scala</a>.  The code is typical for any tool in our pipeline. The main function prepares the data repository and runs through all the datasets that it finds for the given Vertebra.
Each case is processed in a helper functon <code>processCase</code>. Note that in case computation fails for a dataset, an error is logged and the computation continues with the next dataset. Another point to note is the use of the different stages. The data is loaded  by specifying the <code>caseId</code> and in which stage it is in. The input data is
in the stage <code>Initial</code>. After processing, the data is written using the stage <code>Aligned</code>. </p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="defining-the-landmarks"></a>Defining the landmarks<a class="hash-link" href="#defining-the-landmarks" title="Direct link to heading">#</a></h5><p>A landmark tool was used to ensure the sequence of landmarking was maintained across the dataset with the reference being used as the guide. </p><ul><li>TODO: Add landmark tool to pipeline code and refer to it from here. </li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="establishing-correspondence"></a>Establishing Correspondence<a class="hash-link" href="#establishing-correspondence" title="Direct link to heading">#</a></h2><p>Dense correspondence is essential when constructing statistical models. Correspondence between two objects means finding a one-to-one mapping between surface points which define the object as well as intensity values inside the objects. This means that all objects have the same number of points and points with the same identifier on the surface represent the same point/region on another surface.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="building-a-prior-model-for-registration"></a>Building a Prior Model for registration<a class="hash-link" href="#building-a-prior-model-for-registration" title="Direct link to heading">#</a></h3><p>With only one example shape, a point distribution model (PDM) cannot be constructed as it is based on shape deformations being learnt from example shapes. A prior model was, therefore, build analytically using a <a href="https://ieeexplore.ieee.org/iel7/34/4359286/08010438.pdf" target="_blank" rel="noopener noreferrer">Gaussian Process Morphable Model</a>. </p><p>The code for building the model is given in <a href="https://github.com/shape-the-world/vertebra-case-study/blob/main/src/main/scala/modelling/BuildGPModel.scala" target="_blank" rel="noopener noreferrer">BuildGPModel.scala</a></p><p>We see that deformations
are modeled on differnt scales, in order to capture both large global shape differences, as well as differences in local details. We also notice that we build the model using a reference that is a tetrahedral mesh. From this we extract the model for the outer mesh. Both models share the same principal components. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="registration"></a>Registration<a class="hash-link" href="#registration" title="Direct link to heading">#</a></h3><p>Registration is done by using the previously built Gaussian process model as a prior, and a given surface distance as a likelihood. More precisely, let <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Gamma(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">Γ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">)</span></span></span></span></span> denote the surface corresponding to the model coefficients <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span></span></span></span></span>. Registration is
done by solving the following MAP problem</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>arg</mi><mo>⁡</mo><munder><mo><mi>max</mi><mo>⁡</mo></mo><mi>θ</mi></munder><mi>p</mi><mo stretchy="false">(</mo><mi>θ</mi><mi mathvariant="normal">∣</mi><msub><mi mathvariant="normal">Γ</mi><mi>T</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Γ</mi><mi>R</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mo><mi>max</mi><mo>⁡</mo></mo><mi>θ</mi></munder><mi>p</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mi>p</mi><mo stretchy="false">(</mo><msub><mi mathvariant="normal">Γ</mi><mi>T</mi></msub><mi mathvariant="normal">∣</mi><mi>θ</mi><mo separator="true">,</mo><msub><mi mathvariant="normal">Γ</mi><mi>R</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\arg \max_\theta p(\theta | \Gamma_T, \Gamma_R) = \arg \max_\theta p(\theta)p(\Gamma_T | \theta, \Gamma_R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.502108em;vertical-align:-0.752108em"></span><span class="mop">ar<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.43055999999999994em"><span style="top:-2.347892em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">θ</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.752108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mord">∣</span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.502108em;vertical-align:-0.752108em"></span><span class="mop">ar<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.43055999999999994em"><span style="top:-2.347892em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">θ</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.752108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">)</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div><p>where <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>∈</mo><mi>N</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(\theta) \in N(0, I)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:0.07847em">I</span><span class="mclose">)</span></span></span></span></span> is a prior on the model coefficients and the likelihood is <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><msub><mi mathvariant="normal">Γ</mi><mi>T</mi></msub><mi mathvariant="normal">∣</mi><mi>θ</mi><mo separator="true">,</mo><msub><mi mathvariant="normal">Γ</mi><mi>R</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>Z</mi></mfrac><mi>exp</mi><mo>⁡</mo><mrow><mo>−</mo><msup><mi>λ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>M</mi><mo stretchy="false">[</mo><mi mathvariant="normal">Γ</mi><mo stretchy="false">[</mo><mi>θ</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><msub><mi mathvariant="normal">Γ</mi><mi>T</mi></msub><mo stretchy="false">]</mo></mrow></mrow><annotation encoding="application/x-tex">p(\Gamma_T | \theta, \Gamma_R) = \frac{1}{Z}\exp{-\lambda^{-1} M[\Gamma[\theta], \Gamma_T]}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.00773em">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">Z</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord">−</span><span class="mord"><span class="mord mathnormal">λ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="mopen">[</span><span class="mord">Γ</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></span>. Here <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Γ</mi><mo stretchy="false">[</mo><mi>θ</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\Gamma[\theta]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">Γ</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">]</span></span></span></span></span> denotes the surface corresponding to the shape coefficients <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span></span></span></span></span> and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.10903em">M</span></span></span></span></span> is a distance metric. </p><p>Looking at the code, given in <a href="https://github.com/shape-the-world/vertebra-case-study/blob/main/src/main/scala/pipeline/NonrigidRegistration.scala" target="_blank" rel="noopener noreferrer">NonrigidRegistration.scala</a> we notice that the above optimization is not formulated in terms of the probabilistic problem, but as the equivalent energy minimization problem</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>arg</mi><mo>⁡</mo><munder><mo><mi>min</mi><mo>⁡</mo></mo><mi>θ</mi></munder><mi>M</mi><mo stretchy="false">[</mo><mi mathvariant="normal">Γ</mi><mo stretchy="false">[</mo><mi>θ</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><msub><mi mathvariant="normal">Γ</mi><mi>T</mi></msub><mo stretchy="false">]</mo><mo>+</mo><mi>λ</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mi mathvariant="normal">∣</mi><msup><mi mathvariant="normal">∣</mi><mn>2</mn></msup><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\arg \min_\theta M[\Gamma[\theta], \Gamma_T] + \lambda ||\theta||^2.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5021079999999998em;vertical-align:-0.7521079999999999em"></span><span class="mop">ar<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.66786em"><span style="top:-2.347892em;margin-left:0em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">θ</span></span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7521079999999999em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="mopen">[</span><span class="mord">Γ</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord">Γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em"></span><span class="mord mathnormal">λ</span><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord">.</span></span></span></span></span></div><p>The first term corresponds to the log likelihood and the regularization term is derived from the (log of the) prior. We notice that this optimization is not only done once,
but performed several times sequentally with decreasing regularization parameter <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em"></span><span class="mord mathnormal">λ</span></span></span></span></span>. This has the effect that in the earlier steps the shape differences are
mainly explained using the leading shape coefficients, whereas in later steps, the flexibility is added to also explain more detailed deformation. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="building-the-pca-model"></a>Building the PCA Model<a class="hash-link" href="#building-the-pca-model" title="Direct link to heading">#</a></h3><p>After all the surfaces were brought into correspondence, the shape model is built (<a href="https://github.com/shape-the-world/vertebra-case-study/blob/main/src/main/scala/modelling/BuildSSM.scala" target="_blank" rel="noopener noreferrer">BuildSSM.scala</a>).  To decreaseThe mean of the SSM is saved and used as the new reference surface used for registration.Thereafter an SSM was built, and the mean used to update the reference surface. This step was repeated until there was no change in the mean surface distance between the reference meshes. This removed the bias due to picking one of the example shapes as the reference.
Once a stable reference surface has been obtained and the dataset is aligned and registered. After registration, each inverse of the rigid transformation was used to retrieve the entire dataset to its original spatial position of the surfaces. </p><p>The correspondence across volumetric shape-intensity of the L1 was obtained by aligning each tetrahedral mesh to its corresponding CT image, and the voxel intensity value of the closest voxel to a mesh vertex was assigned to that vertex. Once intensity values were assigned to the mesh pints for each volumetric mesh, correspondence was created across volumetric shape-intensity. These volumetric shape-intensity of the L1 was then used to create a deformable shape and intensity model of the L1.</p></div><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#data-screening" class="table-of-contents__link">Data screening</a></li><li><a href="#initial-reference-selection" class="table-of-contents__link">Initial reference selection</a></li><li><a href="#alignement" class="table-of-contents__link">Alignement</a></li><li><a href="#establishing-correspondence" class="table-of-contents__link">Establishing Correspondence</a><ul><li><a href="#building-a-prior-model-for-registration" class="table-of-contents__link">Building a Prior Model for registration</a></li><li><a href="#registration" class="table-of-contents__link">Registration</a></li><li><a href="#building-the-pca-model" class="table-of-contents__link">Building the PCA Model</a></li></ul></li></ul></div></div></div></main></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Shape-the-world</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d4b9d08f.js"></script>
<script src="/assets/js/main.879e3bc5.js"></script>
</body>
</html>